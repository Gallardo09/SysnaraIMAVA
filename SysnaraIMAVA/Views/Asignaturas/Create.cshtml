@model SysnaraIMAVA.Models.Asignatura

@{
    ViewData["Title"] = "Crear Asignatura";
}

<div class="container mt-5">
    <h2 class="mb-4 text-center">Registrar Nueva Asignatura</h2>
    <form asp-action="Create" id="createAsignaturaForm" class="bg-light p-4 rounded shadow">
        <div asp-validation-summary="ModelOnly" class="text-danger"></div>

        <div class="row mb-3">
            <div class="col-md-3">
                <div class="form-group">
                    <label asp-for="Idaño" class="control-label">ID Año</label>
                    <select asp-for="Idaño" class="form-control" id="Idaño" asp-items="ViewBag.Idaño"></select>
                </div>
            </div>
            <div class="col-md-3">
                <div class="form-group">
                    <label asp-for="Idgrado" class="control-label">ID Grado</label>
                    <select asp-for="Idgrado" id="Idgrado" class="form-control" asp-items="ViewBag.Idgrado"></select>
                </div>
            </div>
            <div class="col-md-3">
                <div class="form-group">
                    <label asp-for="Grado" class="control-label">Grado</label>
                    <input asp-for="Grado" id="Grado" readonly class="form-control" />
                </div>
            </div>
            <div class="col-md-3">
                <div class="form-group">
                    <label asp-for="Seccion" class="control-label">Sección</label>
                    <input asp-for="Seccion" id="Seccion" readonly class="form-control" />
                </div>
            </div>
        </div>

        <div class="row mb-3">
            <div class="col-md-6">
                <div class="form-group">
                    <label asp-for="Jornada" class="control-label">Jornada</label>
                    <input asp-for="Jornada" id="Jornada" readonly class="form-control" />
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label asp-for="NivelDescripcion" class="control-label">Nivel Descriptivo Académico</label>
                    <input asp-for="NivelDescripcion" id="NivelDescripcion" readonly class="form-control" />
                </div>
            </div>
        </div>

        <div class="row mb-3">
            <div class="col-md-6">
                <div class="form-group">
                    <label asp-for="Idasignatura" class="control-label">ID Asignatura</label>
                    <input asp-for="Idasignatura" id="Idasignatura" class="form-control" />
                </div>
            </div>
        </div>

        <div class="row mb-3">
            <div class="col-md-6">
                <div class="form-group">
                    <label asp-for="Asignatura1" class="control-label">Asignatura</label>
                    <select asp-for="Asignatura1" id="Asignatura1" class="form-control">
                        <option value="">Seleccione una asignatura</option>
                    </select>
                    <input type="text" id="nuevaAsignatura" class="form-control mt-2" style="display:none;" placeholder="Agregar nueva asignatura">
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label asp-for="Periodo" class="control-label">Periodo</label>
                    <select asp-for="Periodo" id="Periodo" class="form-control">
                        <option value="">Seleccione el Periodo</option>
                        <option value="parcial">PARCIAL</option>
                        <option value="semestral">I_SEMESTRE</option>
                        <option value="semestral">II_SEMESTRE</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-12 text-center">
                <button type="submit" class="btn btn-primary" id="guardarBtn">Guardar</button>
                <a class="btn btn-secondary" asp-action="Index">Regresar a la Lista</a>
            </div>
        </div>
    </form>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    @* ID GRADOS SEGUN EL ID AÑO SELECCIONADO *@
    <script>
        $(document).ready(function () {
            $('#Idaño').change(function () {
                var idAnio = $(this).val();
                if (idAnio) {
                    $.get('@Url.Action("GetGradosPorAnio", "Asignaturas")', { idAnio: idAnio })
                        .done(function (grados) {
                            var selectGrado = $('#Idgrado');
                            selectGrado.empty();
                            selectGrado.append($('<option></option>').val('').text('Seleccione un grado'));
                            $.each(grados, function (index, grado) {
                                selectGrado.append($('<option></option>').val(grado.idgrado).text(grado.idgrado));
                            });
                        })
                        .fail(function () {
                            mostrarAlerta('Error al cargar los grados', 'error');
                            limpiarCampos();
                        });
                } else {
                    $('#Idgrado').empty().append($('<option></option>').val('').text('Seleccione un grado'));
                    limpiarCampos();
                }
            });

            function limpiarCampos() {
                $('#Grado').val('');
                $('#Seccion').val('');
                $('#Jornada').val('');
                $('#NivelDescripcion').val('');
                $('#Idasignatura').val('');
                $('#Asignatura1').val('');
                $('#Periodo').val('');
            }

            function mostrarAlerta(mensaje, tipo) {
                Swal.fire({
                    title: 'Atención',
                    text: mensaje,
                    icon: tipo,
                    timer: 3000,
                    timerProgressBar: true,
                    showConfirmButton: false
                });
            }
        });
    </script>

    @* FUNCION PARA AUTORELLENER LOS DEMAS DATOS AL SELECCIONAR EL ID GRADO *@
    <script>
        $(document).ready(function () {
            // Evento change para el select de Idgrado
            $('#Idgrado').change(function () {
                var idGrado = $(this).val();
                if (idGrado) {
                    $.get('@Url.Action("GetDetallesGrado", "Asignaturas")', { idGrado: idGrado })
                        .done(function (detalles) {
                            if (detalles) {
                                $('#Grado').val(detalles.grado1);
                                $('#Seccion').val(detalles.seccion);
                                $('#Jornada').val(detalles.jornada);
                                $('#NivelDescripcion').val(detalles.nivelDescripcion);
                            } else {
                                limpiarCampos();
                            }
                        })
                        .fail(function () {
                            mostrarAlerta('Error al cargar los detalles del grado', 'error');
                            limpiarCampos();
                        });
                } else {
                    limpiarCampos();
                }
            });

            function limpiarCampos() {
                $('#Grado').val('');
                $('#Seccion').val('');
                $('#Jornada').val('');
                $('#NivelDescripcion').val('');
            }

            function mostrarAlerta(mensaje, tipo) {
                Swal.fire({
                    title: 'Atención',
                    text: mensaje,
                    icon: tipo,
                    timer: 3000,
                    timerProgressBar: true,
                    showConfirmButton: false
                });
            }
        });
    </script>
    @* ID ASIGNATURAS AUTOMÁTICO  *@
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const idAsignaturaElement = document.querySelector('input[name="Idasignatura"]');

            async function getNextAsignaturaId() {
                try {
                    const response = await fetch('/Asignaturas/GetNextAsignaturaId');
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return await response.json();
                } catch (error) {
                    console.error('Error fetching next asignatura ID:', error);
                    return null;
                }
            }

            async function updateIdAsignatura() {
                console.log('Actualizando ID Asignatura');

                const nextId = await getNextAsignaturaId();
                if (nextId) {
                    const nuevoId = `ASIG-${nextId}`;
                    idAsignaturaElement.value = nuevoId;
                    console.log('Nuevo ID:', nuevoId);
                } else {
                    idAsignaturaElement.value = '';
                    console.log('Error al obtener el siguiente ID');
                }
            }

            // Actualización inicial
            updateIdAsignatura();
        });
    </script>

    @* SCRIPT PARA PODER SELECCIONAR UNA ASIGNATURA DEPENDIENDO DEL GRADO SELECCIONADO O INGRESAR LA ASIGNATURA MANUALMENTE *@
    <script>
        $(document).ready(function () {
            const gradoInput = $('#Grado');
            const asignaturaSelect = $('#Asignatura1');
            const nuevaAsignaturaInput = $('#nuevaAsignatura');

            // Objeto con las asignaturas por grado
        const asignaturasPorGrado = {
            'SÉPTIMO GRADO': ['ESPAÑOL', 'INGLÉS', 'EDUCACIÓN ARTÍSTICA', 'MATEMÁTICA', 'CIENCIAS NATURALES', 'ESTUDIOS SOCIALES', 'EDUCACIÓN CÍVICA', 'EDUCACIÓN FÍSICA Y DEPORTES', 'TECNOLOGÍA'],
            'OCTAVO GRADO': ['ESPAÑOL', 'INGLÉS', 'EDUCACIÓN ARTÍSTICA', 'MATEMÁTICAS', 'CIENCIAS NATURALES', 'ESTUDIOS SOCIALES', 'EDUCACIÓN CÍVICA', 'EDUCACIÓN FÍSICA Y DEPORTES', 'TECNOLOGÍA'],
            'NOVENO GRADO': ['ESPAÑOL', 'INGLÉS', 'EDUCACIÓN ARTÍSTICA', 'MATEMÁTICA', 'CIENCIAS NATURALES', 'ESTUDIOS SOCIALES', 'EDUCACIÓN CÍVICA', 'EDUCACIÓN FÍSICA Y DEPORTES', 'TECNOLOGÍA'],
            'DÉCIMO GRADO': ['ESPAÑOL', 'FÍSICA', 'QUÍMICA', 'BIOLOGÍA', 'HISTORIA DE HONDURAS', 'SOCIOLOGÍA', 'INGLÉS', 'INFORMÁTICA', 'FUNDAMENTOS DE PSICOLOGÍA', 'EDUCACIÓN FÍSICA Y DEPORTES'],
            'UNDÉCIMO GRADO': {
                'BACHILLERATO TÉCNICO PROFESIONAL EN INFORMÁTICA': [
                    'ANÁLISIS Y DISEÑO DE SISTEMAS',
                    'EDUCACIÓN Y APRECIACIÓN ARTÍSTICA',
                    'ESPAÑOL',
                    'FILOSOFÍA ',
                    'FÍSICA',
                    'INFORMÁTICA APLICADA',
                    'INGLÉS TÉCNICO ',
                    'LEGISLACIÓN APLICADA A LA INFORMÁTICA ',
                    'MATEMÁTICA',
                    'OFIMÁTICA',
                    'PROGRAMACIÓN I'
                ],
                'BACHILLERATO TÉCNICO PROFESIONAL EN ADMINISTRACIÓN DE EMPRESAS': [
                    'MATEMÁTICA FINANCIERA',
                    'ESPAÑOL II',
                    'EDUCACIÓN Y APRECIACIÓN ARTÍSTICA',
                    'INGLÉS TÉCNICO',
                    'FILOSOFÍA',
                    'LEGISLACIÓN MERCANTIL',
                    'CULTURA EMPRESARIAL ',
                    'ESTADÍSTICA PARA ADMINISTRADORES',
                    'CONTABILIDAD BÁSICA',
                    'ADMINISTRACIÓN ORGANIZACIONAL',
                    'INVESTIGACIÓN Y FORMULACIÓN DE PROYECTO EMPRESARIAL',
                    'INFORMÁTICA EMPRESARIAL'
                ],
                'BACHILLERATO TÉCNICO PROFESIONAL EN ADMINISTRACIÓN HOTELERA': [
                    'EDUCACIÓN Y APRECIACIÓN ARTÍSTICA',
                    'ESPAÑOL',
                    'FILOSOFÍA',
                    'GESTIÓN DE HABITACIONES Y LAVANDERÍA',
                    'GESTIÓN EMPRESARIAL',
                    'INGLÉS TÉCNICO',
                    'INTRODUCCIÓN AL TURISMO',
                    'LEGISLACIÓN TURÍSTICA',
                    'MATEMÁTICA FINANCIERA',
                    'SEGURIDAD LABORAL EN EMPRESAS HOTELERAS',
                    'TÉCNICAS DE RECEPCIÓN Y CONSERJERÍA',
                    'VENTA Y MANEJO EN CAJA EN HOTELERÍA'
                ],
                'BACHILLERATO PROFESIONAL EN CIENCIAS Y HUMANIDADES': [
                    'MATEMÁTICA II',
                    'ESPAÑOL II',
                    'FÍSICA II',
                    'QUÍMICA II',
                    'BIOLOGÍA II',
                    'INGLÉS II',
                    'INTRODUCCIÓN A LA ECONOMÍA',
                    'ANTROPOLOGÍA',
                    'HISTORIA UNIVERSAL',
                    'FILOSOFÍA',
                    'EDUACIÓN Y APRECIACIÓN ARTÍSTICA'
                ],
                'BACHILLERATO PROFESIONAL EN CIENCIAS Y HUMANIDADES (ACELERADO)': [
                    'MATEMÁTICA II',
                    'ESPAÑOL II',
                    'FÍSICA II',
                    'QUÍMICA II',
                    'BIOLOGÍA II',
                    'INGLÉS II',
                    'INTRODUCCIÓN A LA ECONOMÍA',
                    'ANTROPOLOGÍA',
                    'HISTORIA UNIVERSAL',
                    'FILOSOFÍA',
                    'EDUACIÓN Y APRECIACIÓN ARTÍSTICA'
                ]
            },
            'DUODÉCIMO GRADO': {
                'BACHILLERATO TÉCNICO PROFESIONAL EN INFORMÁTICA': [
                    'DESARROLLO WEB',
                    'GESTIÓN EMPRESARIAL ORIENTADA A INFORMÁTICA',
                    'MANTENIMIENTO Y REPACIÓN',
                    'PRODUCCIONES DIGITALES',
                    'PROGRAMACIÓN II',
                    'REDES INFORMÁTICAS'
                ],
                'BACHILLERATO TÉCNICO PROFESIONAL EN ADMINISTRACIÓN DE EMPRESAS': [
                    'TALENTO HUMANO',
                    'MERCADOTECNIA EMPRESARIAL',
                    'GERENCIA DE PRODUCCIÓN Y OPERACIONES',
                    'AUDITORÍA',
                    'ADMINISTRACIÓN FINANCIERA EMPRESARIAL',
                    'INFORMÁTICA CONTABLE',
                    'CONSTABILIDAD DE COSTOS',
                    'CONSTABILIDAD DE SOCIEDADES',
                    'PLANEACIÓN ESTRATÉGICA Y VENTA'
                ],
                'BACHILLERATO TÉCNICO PROFESIONAL EN ADMINISTRACIÓN HOTELERA': [
                    'INTRODUCCIÓN AL ÁREA DE ALIMENTOS Y BEBIDAS',
                    'COCINA BÁSICA',
                    'PREPARACIÓN DE ALIMENTOS PARA CÓCTELES',
                    'PLANIFICACIÓN Y CONTROL DE ALIMENTOS Y BEBIDAS',
                    'ELABORACIÓN DE MENÚ Y VINO',
                    'TÉCNICAS DE SERVICIO EN RESTAURANTE',
                    'TÉCNICAS DE SERVICIO EN BAR',
                    'ORGANIZACIÓN Y EJECUCIÓN DE EVENTOS',
                    'FUNDAMENTOS DE ADMINISTRACIÓN HOTELERA',
                    'SISTEMAS DE COMUNICACIONES TURÍSTICAS'
                ]
            }
        };

            // Función para cargar asignaturas según el grado
            function cargarAsignaturas(grado) {
                asignaturaSelect.empty();
                asignaturaSelect.append($('<option></option>').val('').text('Seleccione una asignatura'));

                // Si el grado tiene carreras (UNDÉCIMO y DUODÉCIMO)
                if (typeof asignaturasPorGrado[grado] === 'object' && !Array.isArray(asignaturasPorGrado[grado])) {
                    // Primero mostramos las carreras
                    const carreras = Object.keys(asignaturasPorGrado[grado]);
                    carreras.forEach(carrera => {
                        asignaturaSelect.append($('<option></option>')
                            .val(carrera)
                            .text(carrera)
                            .addClass('carrera-option')
                            .prop('disabled', true));

                        // Luego las asignaturas de cada carrera
                        asignaturasPorGrado[grado][carrera].forEach(asignatura => {
                            asignaturaSelect.append($('<option></option>').val(asignatura).text(asignatura));
                        });
                    });
                }
                // Para grados sin carreras
                else if (Array.isArray(asignaturasPorGrado[grado])) {
                    asignaturasPorGrado[grado].forEach(asignatura => {
                        asignaturaSelect.append($('<option></option>').val(asignatura).text(asignatura));
                    });
                }

                asignaturaSelect.append($('<option></option>').val('NUEVA').text('Agregar nueva asignatura'));
            }

            // Observar cambios en el input de Grado
            function checkGradoChanges() {
                let currentGrado = gradoInput.val();
                setInterval(() => {
                    if (gradoInput.val() !== currentGrado) {
                        currentGrado = gradoInput.val();
                        cargarAsignaturas(currentGrado);
                    }
                }, 100);
            }

            checkGradoChanges();

            // Manejar la selección de asignatura
            asignaturaSelect.change(function () {
                const selectedValue = $(this).val();

                if (selectedValue === 'NUEVA') {
                    nuevaAsignaturaInput.show();
                } else {
                    // Verificar si se seleccionó una carrera (que está deshabilitada)
                    if ($(this).find('option:selected').hasClass('carrera-option')) {
                        $(this).val(''); // No permitir seleccionar la carrera
                    } else {
                        nuevaAsignaturaInput.hide();
                    }
                }
            });

            // Convertir a mayúsculas y agregar nueva asignatura
            nuevaAsignaturaInput.on('input', function () {
                $(this).val($(this).val().toUpperCase());
            }).on('blur', function () {
                let nuevaAsignatura = $(this).val().trim();
                if (nuevaAsignatura) {
                    asignaturaSelect.append($('<option></option>').val(nuevaAsignatura).text(nuevaAsignatura));
                    asignaturaSelect.val(nuevaAsignatura);
                    $(this).hide().val('');
                }
            });
        });
    </script>

    <style>
        body {
            background-color: #f8f9fa;
        }

        .form-control:read-only {
            background-color: #e9ecef;
        }

        label {
            font-weight: bold;
        }

        .btn-primary {
            background-color: #007bff;
            border-color: #007bff;
        }

            .btn-primary:hover {
                background-color: #0056b3;
                border-color: #0056b3;
            }

        .btn-secondary {
            background-color: #6c757d;
            border-color: #6c757d;
        }

            .btn-secondary:hover {
                background-color: #545b62;
                border-color: #4e555b;
            }

        .carrera-option {
            font-weight: bold;
            background-color: #f0f0f0;
            color: #333;
        }
    </style>
}