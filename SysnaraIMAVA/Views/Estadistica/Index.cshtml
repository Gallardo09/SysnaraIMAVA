@{
    ViewData["Title"] = "Estadísticas de Matrículas";
}

<div class="container">
    <h2 class="card-title" style="text-align: center;">DATOS ESTADÍSTICOS</h2>
    <div class="card shadow-sm border-light">
        <div class="card-body">
            <div class="row justify-content-center">
                <div class="col-md-3 mb-2">
                    <label for="filtroAño" class="form-label">Año</label>
                    <select class="form-select" id="filtroAño">
                        <option value="">Seleccione un año</option>
                        @if (ViewBag.Años != null)
                        {
                            @foreach (var año in ViewBag.Años)
                            {
                                <option value="@año.Idaño">@año.Idaño</option>
                            }
                        }
                    </select>
                </div>
            </div>
        </div>
    </div>

    <div class="row justify-content-center">
        <div class="col-md-4 mb-4">
            <div class="card overlay-card matriculados">
                <div class="card-body">
                    <h5 class="card-title">Matriculados</h5>
                    <h3 class="card-text">0</h3>
                    <i class="la la-graduation-cap icon"></i>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-4">
            <div class="card overlay-card ninas">
                <div class="card-body">
                    <h5 class="card-title">Niñas</h5>
                    <h3 class="card-text">0</h3>
                    <i class="la la-female icon"></i>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-4">
            <div class="card overlay-card varones">
                <div class="card-body">
                    <h5 class="card-title">Varones</h5>
                    <h3 class="card-text">0</h3>
                    <i class="la la-male icon"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="row justify-content-center mt-4">
        <div class="col-md-12">
            <h4>Estadísticas por Grado y Sección</h4>
            <table id="tablaEstadisticas" class="table table-striped table-hover" style="width:100%; font-size: 13px;">
                <thead>
                    <tr>
                        <th>ID Grado</th>
                        <th>Grado</th>
                        <th>Sección</th>
                        <th>Total</th>
                        <th>Femenino</th>
                        <th>Masculino</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Los datos se llenarán dinámicamente con JavaScript -->
                </tbody>
            </table>
        </div>
    </div>

    <div class="row justify-content-center mt-4">
        <div class="col-md-12">
            <canvas id="graficoGenero"></canvas>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            let graficoGenero;
            let table = $('#tablaEstadisticas').DataTable({
                columns: [
                    { data: 'idgrado' },
                    { data: 'grado' },
                    { data: 'seccion' },
                    { data: 'total' },
                    { data: 'femenino' },
                    { data: 'masculino' }
                ]
            });

            // Función para animar el conteo
            function animateValue(obj, start, end, duration) {
                let startTimestamp = null;
                const step = (timestamp) => {
                    if (!startTimestamp) startTimestamp = timestamp;
                    const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                    const currentValue = Math.floor(progress * (end - start) + start);
                    $(obj).text(currentValue.toLocaleString());
                    if (progress < 1) {
                        window.requestAnimationFrame(step);
                    }
                };
                window.requestAnimationFrame(step);
            }

            // Función para actualizar las tarjetas con los datos obtenidos
            function actualizarTarjetas(data) {
                animateValue($('.matriculados .card-text')[0], 0, data.totalMatriculados, 1000);
                animateValue($('.ninas .card-text')[0], 0, data.alumnosFemeninos, 1000);
                animateValue($('.varones .card-text')[0], 0, data.alumnosMasculinos, 1000);
            }

            // Función para actualizar la tabla de estadísticas por grado y sección
            function actualizarTabla(data) {
                table.clear().rows.add(data.estadisticasPorGrado).draw();
            }

            // Función para actualizar los gráficos
            function actualizarGraficos(data) {
                const ctxGenero = document.getElementById('graficoGenero').getContext('2d');

                // Destruir gráficos anteriores si existen
                if (graficoGenero) graficoGenero.destroy();

                // Gráfico de género
                graficoGenero = new Chart(ctxGenero, {
                    type: 'pie',
                    data: {
                        labels: ['Femenino', 'Masculino'],
                        datasets: [{
                            data: [data.alumnosFemeninos, data.alumnosMasculinos],
                            backgroundColor: ['#FF6384', '#36A2EB']
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Distribución por Género'
                            }
                        }
                    }
                });
            }

            // Evento para filtrar los datos cuando cambia el selector de año
            $('#filtroAño').change(function () {
                var filtroAño = $('#filtroAño').val();

                $.ajax({
                    url: '@Url.Action("ObtenerDatosEstadisticos", "Estadistica")',
                    type: 'GET',
                    data: { filtroAño: filtroAño },
                    success: function (response) {
                        if (response.success) {
                            actualizarTarjetas(response);
                            actualizarTabla(response);
                            actualizarGraficos(response);
                        } else {
                            console.error("No se pudieron obtener los datos.");
                        }
                    },
                    error: function () {
                        console.error("Ocurrió un error al obtener los datos.");
                    }
                });
            });
        });
    </script>

    <script src="~/lib/jquery360/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="~/lib/datatables.net/jquery.dataTables2.0.5.js"></script>
    <script src="~/lib/datatables.net/dataTables.bootstrap5.js"></script>
}

<style>
    body {
        font-family: 'Arial', sans-serif;
        margin: 0;
        padding: 0;
        background-color: #f4f6f9;
    }

    .header {
        background: linear-gradient(135deg, #0056b3, #003b7d);
        color: white;
        padding: 20px 0;
        position: relative;
        overflow: hidden;
    }

    .card {
        margin-bottom: 20px;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .card-body {
        padding: 20px;
        position: relative;
    }

    .card-title {
        font-size: 24px;
        margin-bottom: 10px;
    }

    .card-text {
        font-size: 36px;
        font-weight: bold;
    }

    .icon {
        font-size: 40px;
        color: #0056b3;
        position: absolute;
        right: 20px;
        top: 20px;
        opacity: 0.3;
    }

    .overlay-card {
        position: relative;
        overflow: hidden;
    }

        .overlay-card::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(0, 86, 179, 0.1), rgba(0, 59, 125, 0.1));
            z-index: 1;
        }

        .overlay-card .card-body {
            position: relative;
            z-index: 2;
        }

    @@media (max-width: 768px) {
        .card-title {
            font-size: 20px;
        }

        .card-text {
            font-size: 28px;
        }

        .icon {
            font-size: 30px;
        }
    }

    @@media (max-width: 480px) {
        .card-title {
            font-size: 18px;
        }

        .card-text {
            font-size: 24px;
        }

        .icon {
            font-size: 24px;
        }
    }
</style>