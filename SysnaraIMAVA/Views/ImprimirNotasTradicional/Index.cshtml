@model IEnumerable<SysnaraIMAVA.Models.Matricula>
@{
    ViewData["Title"] = "Imprimir Notas - Sistema Tradicional";
    var años = ViewBag.Años as List<SysnaraIMAVA.Models.Año>;
}

<div class="container-fluid mt-4">
    <div class="card shadow border-0">
        <div class="card-header bg-primary text-white">
            <div class="d-flex justify-content-between align-items-center">
                <h3 class="mb-0">
                    <i class="fas fa-print me-2"></i> @ViewData["Title"]
                </h3>
                <div class="badge bg-white text-primary fs-6 p-2">
                    <i class="fas fa-calendar-alt me-1"></i> @DateTime.Now.ToString("dd/MM/yyyy")
                </div>
            </div>
        </div>

        <div class="card-body">
            <div class="row mb-4 g-3">
                <div class="col-md-4">
                    <div class="form-floating">
                        <select class="form-select" id="filtroAño">
                            <option value="">Seleccione un año</option>
                            @if (años != null)
                            {
                                @foreach (var año in años)
                                {
                                    <option value="@año.Idaño">@año.Idaño</option>
                                }
                            }
                        </select>
                        <label for="filtroAño">Año Académico</label>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="form-floating">
                        <select class="form-select" id="filtroGrado" disabled>
                            <option value="">Seleccione un grado</option>
                        </select>
                        <label for="filtroGrado">Grado</label>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="form-floating">
                        <select class="form-select" id="filtroSistema">
                            <option value="">Todos los sistemas</option>
                            <option value="TRADICIONAL">TRADICIONAL</option>
                            <option value="ANGLOSAJÓN">ANGLOSAJÓN</option>
                        </select>
                        <label for="filtroSistema">Sistema</label>
                    </div>
                </div>
            </div>

            <div class="table-responsive">
                <table id="matriculasTable" class="table table-hover table-striped" style="width:100%; font-size: 14px;">
                    <thead class="table-dark">
                        <tr>
                            <th>ID Año</th>
                            <th>IDSI</th>
                            <th>Identidad</th>
                            <th>Nombre del Estudiante</th>
                            <th>Género</th>
                            <th>Grado</th>
                            <th>Sistema</th>
                            <th>Grados 1°-6°</th>
                            <th>Grados 7°-9°</th>
                            <th>Grados 10°-12°</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            var table = $('#matriculasTable').DataTable({
                dom: '<"top"f>rt<"bottom"lip><"clear">',
                language: {
                    // url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/es-ES.json'
                    url: 'https://cdn.datatables.net/plug-ins/1.13.6/i18n/es-ES.json'
                    // url: '/lib/datatables/i18n/es-ES.json'
                },
                columns: [
                    { data: 'idaño' },
                    { data: 'idsi' },
                    { data: 'ididentidad' },
                    { data: 'nombreEstudiante' },
                    { data: 'genero' },
                    { data: 'grado' },
                    { data: 'sistema' },
                    {
                        data: 'primaria',
                        render: function (data, type, row) {
                            return renderGradeButton(row, 'primaria');
                        }
                    },
                    {
                        data: 'ciclo',
                        render: function (data, type, row) {
                            return renderGradeButton(row, 'ciclo');
                        }
                    },
                    {
                        data: 'secundaria',
                        render: function (data, type, row) {
                            return renderGradeButton(row, 'secundaria');
                        }
                    }
                ],
                order: [[4, 'asc'], [3, 'asc']]
            });

            // Función para renderizar los botones según el grado
            function renderGradeButton(row, type) {
                var gradosPrimaria = ['PREPARATORY', 'KINDERGARTEN', 'FIRST GRADE', 'SECOND GRADE',
                    'THIRD GRADE', 'FOURTH GRADE', 'FIFTH GRADE', 'SIXTH GRADE'];
                var gradosCiclo = ['SEVENTH GRADE', 'EIGHTH GRADE', 'NINTH GRADE'];
                var gradosSecundaria = ['TENTH GRADE', 'ELEVENTH GRADE', 'TWELVE GRADE'];
                var isPrimaria = gradosPrimaria.includes(row.grado);
                var isCiclo = gradosCiclo.includes(row.grado);
                var isSecundaria = gradosSecundaria.includes(row.grado);

                if ((type === 'primaria' && isPrimaria) || (type === 'ciclo' && isCiclo) || (type === 'secundaria' && isSecundaria)) {
                    var idAño = $('#filtroAño').val();
                    var uniqueId = 'dropdown-' + row.ididentidad + '-' + type;

                    var listadoItems = '';
                    if (isPrimaria) {
                        listadoItems = `
                        <li><a class="dropdown-item" href="/ImprimirNotasTradicional/GenerarNotasIParcialPrimaria?idaño=${row.idaño}&ididentidad=${row.ididentidad}&parcial=1">I Parcial</a></li>
                        <li><a class="dropdown-item" href="/ImprimirNotasTradicional/GenerarNotasIIParcialPrimaria?idaño=${row.idaño}&ididentidad=${row.ididentidad}&parcial=1">II Parcial</a></li>
                        <li><a class="dropdown-item" href="/ImprimirNotasTradicional/GenerarNotasIIIParcialPrimaria?idaño=${row.idaño}&ididentidad=${row.ididentidad}&parcial=1">III Parcial</a></li>
                        <li><a class="dropdown-item" href="/ImprimirNotasTradicional/GenerarNotasIVParcialPrimaria?idaño=${row.idaño}&ididentidad=${row.ididentidad}&parcial=1">IV Parcial</a></li>
                    `;
                    } else if (isCiclo) {
                        listadoItems = `
                        <li><a class="dropdown-item" href="/ImprimirNotasTradicional/GenerarNotasIParcialPrimaria?idaño=${row.idaño}&ididentidad=${row.ididentidad}&parcial=1">I Parcial</a></li>
                        <li><a class="dropdown-item" href="/ImprimirNotasTradicional/GenerarNotasIIParcialPrimaria?idaño=${row.idaño}&ididentidad=${row.ididentidad}&parcial=1">II Parcial</a></li>
                        <li><a class="dropdown-item" href="/ImprimirNotasTradicional/GenerarNotasIIIParcialPrimaria?idaño=${row.idaño}&ididentidad=${row.ididentidad}&parcial=1">III Parcial</a></li>
                        <li><a class="dropdown-item" href="/ImprimirNotasTradicional/GenerarNotasIVParcialPrimaria?idaño=${row.idaño}&ididentidad=${row.ididentidad}&parcial=1">IV Parcial</a></li>
                    `;
                    } else if (isSecundaria) {
                        listadoItems = `
                        <li><a class="dropdown-item" href="/ImprimirNotasTradicional/GenerarNotasIParcialBTP?idaño=${row.idaño}&ididentidad=${row.ididentidad}&parcial=1">I Parcial</a></li>
                        <li><a class="dropdown-item" href="/ImprimirNotasTradicional/GenerarNotasIIParcialBTP?idaño=${row.idaño}&ididentidad=${row.ididentidad}&parcial=1">II Parcial</a></li>
                        <li><a class="dropdown-item" href="/ImprimirNotasTradicional/GenerarNotasIIIParcialBTP?idaño=${row.idaño}&ididentidad=${row.ididentidad}&parcial=1">III Parcial</a></li>
                        <li><a class="dropdown-item" href="/ImprimirNotasTradicional/GenerarNotasIVParcialBTP?idaño=${row.idaño}&ididentidad=${row.ididentidad}&parcial=1">IV Parcial</a></li>
                            `;
                    }

                    return `
                    <div class="dropdown">
                        <button class="btn btn-primary btn-sm dropdown-toggle" type="button" id="${uniqueId}" data-bs-toggle="dropdown" aria-expanded="false">
                            Opciones
                        </button>
                        <ul class="dropdown-menu" aria-labelledby="${uniqueId}">
                            ${listadoItems}
                        </ul>
                    </div>
                `;
                } else {
                    return '<button class="btn btn-secondary btn-sm" disabled><i class="fas fa-ban me-1"></i>No disponible</button>';
                }
            }

            // Cargar grados cuando se selecciona un año
            $('#filtroAño').change(function () {
                var idAño = $(this).val();
                $('#filtroGrado').empty().append('<option value="">Seleccione un grado</option>');

                if (idAño) {
                    $.ajax({
                        url: '/ImprimirNotasTradicional/GetGrados',
                        data: { idAño: idAño },
                        success: function (data) {
                            $.each(data, function (index, item) {
                                $('#filtroGrado').append($('<option>', {
                                    value: item.idgrado,
                                    text: item.gradoCompleto
                                }));
                            });
                            $('#filtroGrado').prop('disabled', false);
                        }
                    });
                } else {
                    $('#filtroGrado').prop('disabled', true);
                    table.clear().draw();
                }
                cargarMatriculas();
            });

            // Cargar matrículas automáticamente al cambiar filtros
            $('#filtroGrado, #filtroSistema').change(cargarMatriculas);

            function cargarMatriculas() {
                var idAño = $('#filtroAño').val();
                var idGrado = $('#filtroGrado').val();
                var sistema = $('#filtroSistema').val();

                if (idAño) {
                    $.ajax({
                        url: '/ImprimirNotasTradicional/GetListaEstudiantesMatricula',
                        data: {
                            idAño: idAño,
                            idGrado: idGrado,
                            sistema: sistema
                        },
                        success: function (data) {
                            table.clear().rows.add(data).draw();
                        },
                        error: function () {
                            toastr.error('Error al cargar los estudiantes');
                        }
                    });
                } else {
                    table.clear().draw();
                }
            }

            // Abrir PDF en nueva pestaña
            $(document).on('click', '.dropdown-item', function(e) {
                e.preventDefault();
                var href = $(this).attr('href');
                if (href && href !== '#') {
                    window.open(href, '_blank');
                }
            });

            // Modificar esta parte para inicializar los dropdowns
            table.on('draw', function () {
                $('.dropdown-toggle').each(function() {
                    new bootstrap.Dropdown(this);
                });
            });
             // Alternativamente, puedes usar eventos delegados
            $(document).on('click', '.dropdown-toggle', function(e) {
                e.preventDefault();
                var dropdownList = $(this).next('.dropdown-menu');
                $('.dropdown-menu').not(dropdownList).removeClass('show');
                dropdownList.toggleClass('show');
            });

            // Cerrar dropdowns al hacer clic fuera
            $(document).on('click', function(e) {
                if (!$(e.target).closest('.dropdown').length) {
                    $('.dropdown-menu').removeClass('show');
                }
            });
        });
    </script>
}

<style>
    .card {
        border-radius: 10px;
        overflow: hidden;
    }

    .table th {
        white-space: nowrap;
        position: relative;
        background-color: #343a40 !important;
        color: white;
    }

    .table td {
        vertical-align: middle;
    }

    .dropdown-menu {
        min-width: 10rem;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        border: none;
    }

    .dropdown-item {
        padding: 0.5rem 1rem;
        transition: all 0.2s;
    }

        .dropdown-item:hover {
            background-color: #0d6efd;
            color: white !important;
        }

    .badge {
        border-radius: 50px;
        font-weight: 500;
    }

    .form-floating label {
        color: #6c757d;
    }

    .btn-sm {
        padding: 0.25rem 0.5rem;
        font-size: 0.8rem;
    }

        .btn-sm i {
            margin-right: 0.25rem;
        }
</style>