@model IEnumerable<SystemSysnara.Models.PersonalidadIi> //IIParcial
@{
    ViewData["Title"] = "Registrar Personalidad II Parcial"; //IIParcial
    var años = ViewBag.Años as List<SystemSysnara.Models.Año>;
}

<div class="notas-container">
    <div class="row">
        <div class="notas-header">
            <h1 class="notas-title">Registro de Personalidad del II Parcial</h1> @* //IIParcial *@
        </div>
        <div class="notas-filters">
            <div class="col-2">
                <label for="filtroAño">Año</label>
                <select class="form-select" id="filtroAño">
                    <option value="">Seleccione un año</option>
                    @if (años != null)
                    {
                        foreach (var año in años)
                        {
                            <option value="@año.Idaño">@año.Idaño</option>
                        }
                    }
                </select>
            </div>
            <div class="filter-group">
                <label for="filtroGrado">Grado</label>
                <select class="form-select" id="filtroGrado" disabled>
                    <option value="">Seleccione un grado</option>
                </select>
            </div>
            <div class="col-2">
                <label>&nbsp;</label>
                <button id="BtnDescargar" class="btn btn-primary btn-sm form-control" disabled>
                    <i class="fa-regular fa-circle-down"></i> Descargar
                </button>
            </div>
            <div class="col-2">
                <label>&nbsp;</label>
                <button id="BtnSubir" class="btn btn-success form-control" data-bs-toggle="modal" data-bs-target="#miModal">
                    <i class="fa-regular fa-circle-up"></i> Subir
                </button>
            </div>
        </div>
    </div>
</div>

<table id="PersonalidadTable" class="table table-striped table-hover" style="width:100%; font-size: 13px;">
    <thead>
        <tr>
            <th>Año</th>
            <th>ID Est</th>
            <th>DNI</th>
            <th>Nombre del Estudiante</th>
            <th>Género</th>
            <th>ID Personalidad</th>
            <th>Puntualidad</th>
            <th>Orden y Presentación</th>
            <th>Moralidad</th>
            <th>Espíritu de Trabajo</th>
            <th>Sociabilidad</th>
            <th>Inasistencias</th>
        </tr>
    </thead>
    <tbody>
    </tbody>
</table>


<!-- MODAL SUBIR PERSONALIDAD -->
<div class="modal fade" id="miModal" tabindex="-1" aria-labelledby="miModalLabel" aria-hidden="true">
    <div class="modal-dialog" style="max-width: 800px;">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="miModalLabel">Cargar Archivo PERSONALIDAD de Excel "II Parcial"</h5> @* //IIParcial *@
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="file" class="form-control" accept=".xls,.xlsx" id="archivoExcel">
            </div>
            <div class="modal-footer d-flex justify-content-evenly">
                <div class="col-5">
                    <button type="button" class="btn btn-secondary w-100" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> Cerrar
                    </button>
                </div>
                <div class="col-5">
                    <button type="button" class="btn btn-primary w-100" id="btnSubirModal">
                        <i class="fas fa-upload"></i> Subir
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            var table = $('#PersonalidadTable').DataTable({
                columns: [
                    { data: 'idaño' },
                    { data: 'idest' },
                    { data: 'ididentidad' },
                    { data: 'nombreestudiante' },
                    { data: 'genero' },
                    { data: 'idpersonalidadii' },
                    { data: 'puntualidad' },
                    { data: 'ordenypresentacion' },
                    { data: 'moralidad' },
                    { data: 'espiritudetrabajo' },
                    { data: 'sociabilidad' },
                    { data: 'inasistencias' }
                ]
            });

            $('#filtroAño').change(function () {
                var idAño = $(this).val();
                $('#filtroGrado').empty().append('<option value="">Seleccione un grado</option>');
                if (idAño) {
                    $.ajax({
                        url: '/PersonalidadIIParcial/GetGrados',
                        data: { idAño: idAño },
                        success: function (data) {
                            $.each(data, function (index, item) {
                                $('#filtroGrado').append($('<option>', {
                                    value: item.idgrado,
                                    text: item.gradoCompleto
                                }));
                            });
                            $('#filtroGrado').prop('disabled', false);
                        }
                    });
                } else {
                    $('#filtroGrado').prop('disabled', true);
                }
                table.clear().draw();
            });

            $('#filtroGrado').change(function () {
                cargarMatriculas();
                habilitarBotonDescarga();
            });

            // Función para cargar los datos en la tabla
            function cargarMatriculas() {
                var idAño = $('#filtroAño').val();
                var idGrado = $('#filtroGrado').val();

                if (idAño && idGrado) {
                    $.ajax({
                        url: '/PersonalidadIIParcial/GetPersonalidadesDelParcial',
                        data: { idAño: idAño, idGrado: idGrado },
                        success: function (response) {
                            if (response.success) {
                                // Si la respuesta es exitosa, añadimos los datos a la tabla
                                table.clear().rows.add(response.data).draw();
                            } else {
                                // Si no hay datos, mostramos un mensaje con SweetAlert2
                                table.clear().draw(); // Limpiar la tabla
                                Swal.fire({
                                    icon: 'warning',
                                    title: 'Oops...',
                                    text: response.message,
                                });
                            }
                        }
                    });
                } else {
                    table.clear().draw();
                }
            }

            // Habilitar el botón de descarga si ambos filtros están seleccionados
            function habilitarBotonDescarga() {
                var idAño = $('#filtroAño').val();
                var idGrado = $('#filtroGrado').val();
                if (idAño && idGrado) {
                    $('#BtnDescargar').prop('disabled', false);
                } else {
                    $('#BtnDescargar').prop('disabled', true);
                }
            }

            //DESCARGAR BOTON FORMATO DE EXCEL
            $('#BtnDescargar').click(function () {
            var idAño = $('#filtroAño').val();
            var idGrado = $('#filtroGrado').val();

                if (idAño && idGrado) {
                    // Verificar si existen datos para ese Año y Grado
                    $.ajax({
                        url: '/PersonalidadIIParcial/VerificarDatos', //II Parcial nombre del controlador.
                        type: 'GET',
                        data: { idAño: idAño, idGrado: idGrado },
                        success: function(response) {
                            if (response.existeDatos) {
                                // Si hay datos, descargar con DescargarExcel
                                window.location.href = '/PersonalidadIIParcial/DescargarExcel?idAño=' + idAño + '&idGrado=' + idGrado; //II Parcial nombre del controlador.
                            } else {
                                // Si no hay datos, descargar con DescargarExcelenBlancoPersonalidad
                                window.location.href = '/PersonalidadIIParcial/DescargarExcelenBlancoPersonalidad?idAño=' + idAño + '&idGrado=' + idGrado; //II Parcial nombre del controlador.
                            }
                        },
                        error: function() {
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: 'Ocurrió un error al verificar los datos.',
                                confirmButtonText: 'Aceptar'
                            });
                        }
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'Por favor seleccione un Año y un Grado para poder descargar el archivo.',
                        confirmButtonText: 'Aceptar'
                    });
                }
            });

        });


        //para que cierre el modal
        $('#notasModal').on('click', '[data-dismiss="modal"]', function () {
            $('#notasModal').modal('hide');
        });
    </script>

    <script>
        // SCRIPT Y VALIDACIÓN PARA SUBIR PERSONALIDADES
        $(document).ready(function () {
            $('#btnSubirModal').on('click', function () {
                const archivoInput = $('#archivoExcel')[0];
                const archivo = archivoInput.files[0];
                if (archivo) {
                    const formData = new FormData();
                    formData.append('archivoExcel', archivo);

                    // Mostrar indicador de progreso
                    Swal.fire({
                        title: 'Subiendo personalidades',
                        html: 'Por favor, espere...',
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });

                    $.ajax({
                        type: 'POST',
                        url: '/PersonalidadIIParcial/SubirPersonalidades', // URL del controlador //II Parcial nombre del controlador.
                        data: formData,
                        contentType: false,
                        processData: false,
                        success: function (response) {
                            // Cerrar el modal primero
                            $('#miModal').modal('hide');

                            // Asegurarse de que el backdrop se elimine
                            $('body').removeClass('modal-open');
                            $('.modal-backdrop').remove();

                            // Si el servidor devuelve un mensaje de error, lo mostramos
                            if (response.error) {
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Error',
                                    text: response.error, // Mostrar el mensaje de error recibido
                                    confirmButtonText: 'Aceptar'
                                });
                            } else {
                                // Mostrar el mensaje de éxito
                                Swal.fire({
                                    icon: 'success',
                                    title: '¡Éxito!',
                                    text: response.success, // Mostrar mensaje de éxito
                                    confirmButtonText: 'Aceptar'
                                }).then((result) => {
                                    if (result.isConfirmed) {
                                        // Recargar la página o actualizar la vista si es necesario
                                        location.reload(); // Esto recargará la página
                                    }
                                });
                            }
                        },
                        error: function (xhr) {
                            let errorMessage = 'Ocurrió un error al subir las personalidades.';
                            if (xhr.responseText) {
                                errorMessage = xhr.responseText;
                            }
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: errorMessage,
                                confirmButtonText: 'Aceptar'
                            });
                        }
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'Por favor, selecciona un archivo.',
                        confirmButtonText: 'Aceptar'
                    });
                }
            });
        });
    </script>

    @* EJEMPLO DE TOASTR *@
    <script>
        $(document).ready(function () {
            // Mostrar una notificación Toastr al hacer clic en un botón
            $('#BtnNotificacion').click(function () {
                toastr.success('¡Notificación mostrada correctamente!', 'Éxito');
            });
        });
    </script>
}

<style>
    .notas-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 1rem;
        background-color: #f8f9fa;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .notas-header {
        text-align: center;
        margin-bottom: 1rem;
    }

    .notas-title {
        font-family: 'Russo One', sans-serif;
        color: #007bff;
        font-size: 2rem;
        text-transform: uppercase;
        letter-spacing: 2px;
    }

    .notas-filters {
        display: flex;
        justify-content: space-between;
        align-items: flex-end;
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .filter-group {
        flex: 1;
    }

        .filter-group label {
            display: block;
            margin-bottom: 0.25rem;
            font-weight: bold;
            color: #495057;
        }

    .form-select, .btn {
        width: 100%;
        padding: 0.375rem 0.75rem;
        font-size: 0.9rem;
    }

    .action-btn {
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
        line-height: 1.5;
        white-space: nowrap;
        width: auto;
    }

        .action-btn i {
            margin-right: 0.25rem;
        }

    #PersonalidadTable td {
        vertical-align: middle;
    }

    /*    @@media (max-width: 768px) {
                .notas-filters {
                    flex-direction: column;
                }

                .filter-group {
                    width: 100%;
                }
            } */

    .modal-lg-custom {
        max-width: 90%; /* Cambia este valor según lo necesites */
    }
</style>